<?php
// Habilitar la depuración de errores
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Configuración de la base de datos
$servidor = "proyecto/PALE";
$usuario = "sa";
$password = "Pale123456789";
$base_datos = "Residencias";

// Conexión a SQL Server
$connectionInfo = array("Database" => $base_datos, "UID" => $usuario, "PWD" => $password);
$conn = sqlsrv_connect($servidor, $connectionInfo);

// Verificar conexión
if ($conn === false) {
    die(print_r(sqlsrv_errors(), true));
}
echo "Conexión exitosa<br>";

// Depurar los datos recibidos
echo "<h3>Datos recibidos:</h3>";
var_dump($_POST);
var_dump($_FILES);
echo "<br>";

// Verificar que se hayan enviado todos los datos esperados
if (!isset($_POST['empresa'], $_POST['contacto'], $_POST['proyecto'], $_POST['descripcion'], $_POST['fecha_inicio'], $_POST['fecha_fin'], $_FILES['archivo'])) {
    die("Faltan datos del formulario. Revisa que todos los campos estén completos.");
}

// Obtener datos del formulario
$empresa = $_POST['empresa'];
$contacto = $_POST['contacto'];
$proyecto = $_POST['proyecto'];
$descripcion = $_POST['descripcion'];
$fecha_inicio = $_POST['fecha_inicio'];
$fecha_fin = $_POST['fecha_fin'];

// Procesar archivo subido
$directorio_subida = "uploads/";
if (!file_exists($directorio_subida)) {
    mkdir($directorio_subida, 0777, true); // Crear carpeta si no existe
}

$nombre_archivo = basename($_FILES['archivo']['name']);
$ruta = $directorio_subida . $nombre_archivo;

// Intentar mover el archivo subido
if (!move_uploaded_file($_FILES['archivo']['tmp_name'], $ruta)) {
    die("Error al subir el archivo. Verifica los permisos de la carpeta 'uploads/'.");
}
echo "Archivo subido exitosamente: " . $ruta . "<br>";

// Insertar datos en la base de datos
$sql = "INSERT INTO proyectos (empresa, contacto, proyecto, descripcion, fecha_inicio, fecha_fin, archivo) 
        VALUES (?, ?, ?, ?, ?, ?, ?)";

$params = array($empresa, $contacto, $proyecto, $descripcion, $fecha_inicio, $fecha_fin, $ruta);
$stmt = sqlsrv_query($conn, $sql, $params);

// Verificar la ejecución de la consulta
if ($stmt === false) {
    die(print_r(sqlsrv_errors(), true));
}

echo "Datos guardados correctamente en la base de datos.<br>";

// Cerrar conexión
sqlsrv_close($conn);

// Redirigir al banco de proyectos
header("Location: banco_de_proyectos.php");
exit();
?>
